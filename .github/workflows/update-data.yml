name: Update Dashboard Data

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch pipeline data
        env:
          AXOVIA_AI_TOKEN: ${{ secrets.AXOVIA_AI_TOKEN }}
          AXOVIA_ASPEN_TOKEN: ${{ secrets.AXOVIA_ASPEN_TOKEN }}
        run: |
          # Fetch data for each repo and combine into dashboard.json
          
          fetch_repo() {
            local owner=$1
            local repo=$2
            local token=$3
            local name=$4
            
            echo "Fetching $owner/$repo..."
            
            # Commits
            commits=$(curl -s -H "Authorization: token $token" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$owner/$repo/commits?per_page=5" 2>/dev/null || echo "[]")
            
            # Workflow runs
            runs=$(curl -s -H "Authorization: token $token" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$owner/$repo/actions/runs?per_page=10" 2>/dev/null || echo '{"workflow_runs":[]}')
            
            # Releases
            releases=$(curl -s -H "Authorization: token $token" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$owner/$repo/releases?per_page=1" 2>/dev/null || echo "[]")
            
            # Build JSON object
            echo "{\"owner\":\"$owner\",\"repo\":\"$repo\",\"name\":\"$name\",\"commits\":$commits,\"runs\":$runs,\"releases\":$releases}"
          }
          
          # Fetch all repos
          docmind=$(fetch_repo "Axovia-AI" "docmind-ai" "$AXOVIA_AI_TOKEN" "Docmind AI")
          website=$(fetch_repo "Axovia-AI" "axovia-website" "$AXOVIA_AI_TOKEN" "Axovia Website")
          flipper=$(fetch_repo "AXOVIA-ASPEN" "flipper-ai" "$AXOVIA_ASPEN_TOKEN" "Flipper AI")
          
          # Combine into array
          echo "{\"updatedAt\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"repos\":[$docmind,$website,$flipper]}" > data.json
          
          # Pretty print for debugging
          cat data.json | head -c 500
          echo "..."

      - name: Commit and push if changed
        run: |
          git config user.name "ASPEN Bot"
          git config user.email "aspen@silverlinesoftware.co"
          git add data.json
          git diff --staged --quiet || git commit -m "ðŸ“Š Update dashboard data [skip ci]"
          git push
