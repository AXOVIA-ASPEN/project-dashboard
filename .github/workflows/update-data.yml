name: Update Dashboard Data

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main]
    paths-ignore:
      - 'data.json'

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch pipeline data
        env:
          AXOVIA_AI_TOKEN: ${{ secrets.AXOVIA_AI_TOKEN }}
          AXOVIA_ASPEN_TOKEN: ${{ secrets.AXOVIA_ASPEN_TOKEN }}
        run: |
          fetch_repo() {
            local owner=$1
            local repo=$2
            local token=$3
            local name=$4
            
            # Commits
            commits=$(curl -sf -H "Authorization: token $token" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$owner/$repo/commits?per_page=5" 2>/dev/null || echo "[]")
            
            # Workflow runs
            runs=$(curl -sf -H "Authorization: token $token" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$owner/$repo/actions/runs?per_page=10" 2>/dev/null || echo '{"workflow_runs":[]}')
            
            # Releases
            releases=$(curl -sf -H "Authorization: token $token" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$owner/$repo/releases?per_page=1" 2>/dev/null || echo "[]")
            
            # Output valid JSON
            jq -n \
              --arg owner "$owner" \
              --arg repo "$repo" \
              --arg name "$name" \
              --argjson commits "$commits" \
              --argjson runs "$runs" \
              --argjson releases "$releases" \
              '{owner: $owner, repo: $repo, name: $name, commits: $commits, runs: $runs, releases: $releases}'
          }
          
          # Fetch all repos
          docmind=$(fetch_repo "Axovia-AI" "docmind-ai" "$AXOVIA_AI_TOKEN" "Docmind AI")
          website=$(fetch_repo "Axovia-AI" "axovia-website" "$AXOVIA_AI_TOKEN" "Axovia Website")
          flipper=$(fetch_repo "AXOVIA-ASPEN" "flipper-ai" "$AXOVIA_ASPEN_TOKEN" "Flipper AI")
          n8n=$(fetch_repo "AXOVIA-ASPEN" "n8n-server" "$AXOVIA_ASPEN_TOKEN" "n8n Server")
          rrdp=$(fetch_repo "AXOVIA-ASPEN" "real-random-dev-portal" "$AXOVIA_ASPEN_TOKEN" "Real Random Dev Portal")
          
          # Combine into final JSON
          jq -n \
            --arg updatedAt "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --argjson docmind "$docmind" \
            --argjson website "$website" \
            --argjson flipper "$flipper" \\
            --argjson n8n "$n8n" \\
            --argjson rrdp "$rrdp" \
            '{updatedAt: $updatedAt, repos: [$docmind, $website, $flipper, $n8n, $rrdp]}' > data.json
          
          echo "Generated data.json:"
          jq '.updatedAt, (.repos[] | "\(.name): \(.runs.workflow_runs[0].conclusion // \"no CI\")")' data.json

      - name: Commit and push if changed
        run: |
          git config user.name "ASPEN Bot"
          git config user.email "aspen@silverlinesoftware.co"
          git add data.json
          git diff --staged --quiet || git commit -m "ðŸ“Š Update dashboard data [skip ci]"
          git push
